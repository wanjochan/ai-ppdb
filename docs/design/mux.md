# 多路复用模块设计文档

## 1. 背景

在高性能服务器开发中，需要高效处理大量并发I/O操作。不同平台提供了不同的多路复用机制：
- Linux: epoll
- Windows: IOCP (I/O Completion Port)
- 通用: select (用于调试)

为了统一这些接口，同时保持高性能，我们设计了这个多路复用抽象层。

## 2. 设计目标

1. 提供统一的跨平台接口
2. 保持原生性能
3. 支持不同类型的I/O操作
4. 易于使用和维护
5. 可配置和可扩展

## 3. 核心接口

```
infra_mux.h
```

## 4. I/O支持范围

### 4.1 Windows (IOCP)
- Socket I/O: ✓ 完全支持
- Disk I/O: ✓ 完全支持（需要以异步模式打开文件）
- 命名管道: ✓ 支持
- 其他设备: △ 部分支持

### 4.2 Linux (epoll)
- Socket I/O: ✓ 完全支持
- Disk I/O: △ 有限支持（建议使用独立线程池）
- Pipe/FIFO: ✓ 支持
- 终端设备: ✓ 支持
- 信号: ✓ 支持（通过signalfd）
- 定时器: ✓ 支持（通过timerfd）

## 5. 使用示例

### 5.1 简单的时间查询服务器
```c
brev.
```

### 5.2 配合线程池使用
```c
brev.
```

## 6. 最佳实践

1. **Socket I/O处理**:
   - 使用非阻塞模式
   - 合理设置缓冲区大小
   - 注意处理EAGAIN错误

2. **磁盘I/O处理**:
   - Windows: 使用异步模式打开文件
   - Linux: 使用独立的线程池或libaio

3. **性能优化**:
   - 合理设置max_events大小
   - 使用边缘触发模式(epoll)
   - 避免频繁添加/删除描述符

4. **错误处理**:
   - 总是检查返回值
   - 正确清理资源
   - 处理断开连接的情况

## 7. 注意事项

1. 不同平台的特性差异
2. 文件描述符限制
3. 内存使用考虑
4. 错误处理策略
5. 性能监控和调优 
