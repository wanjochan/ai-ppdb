# APE (Actually Portable Executable) 文件格式

APE 是 Cosmopolitan 项目引入的一种创新性可执行文件格式，旨在实现真正的跨平台二进制兼容。

## 核心特性

### 多重文件头
- DOS MZ 头（Windows 兼容）
- ELF 头（Linux/BSD 兼容）
- Mach-O 头（macOS 兼容）
- 巧妙的头部设计使得各系统都认为是原生格式

### 统一运行时
- 自包含的 C 运行时
- 跨平台 syscall 抽象层
- 无需外部依赖

### 平台检测和适配
- 运行时平台检测
- 自动选择合适的系统调用
- 动态适配系统 ABI

## 技术细节

### 文件布局
```
+------------------+
| DOS/MZ 头        | ← Windows 入口
+------------------+
| ELF 头          | ← Linux 入口
+------------------+
| Mach-O 头       | ← macOS 入口
+------------------+
| 代码段          |
+------------------+
| 数据段          |
+------------------+
```

### 运行机制
1. 系统加载器识别对应格式头
2. 跳转到平台特定入口点
3. 初始化运行时环境
4. 执行统一的程序逻辑

### 优势
- 单一二进制文件
- 无需重新编译
- 最小化依赖
- 接近原生性能

## 限制和注意事项
- 文件体积较大（包含完整运行时）
- 仅支持静态链接
- 部分系统调用可能不完全兼容
- 需要特定的构建工具链

## 动态库展望

目前 Cosmopolitan 项目仅支持静态链接的可执行文件，尚未提供动态库支持。我们计划探索类似 APE 的跨平台动态库实现：

### 技术挑战
- 多平台动态链接器兼容
- 运行时符号解析和重定位
- 平台特定的动态库加载机制适配

### 可能的实现方案
1. 多重动态库头部
   - Windows: DLL 格式头
   - Linux: SO 格式头
   - macOS: DYLIB 格式头

2. 统一的符号导出机制
   - 跨平台符号命名约定
   - 统一的版本控制方案
   - 通用的符号可见性控制

3. 运行时适配层
   - 动态符号解析桥接
   - 平台特定重定位处理
   - 异常处理兼容

4. 加载器支持
   - 扩展现有 APE 加载器
   - 实现动态链接支持
   - 处理平台特定的加载需求

这将是对 APE 格式的重要补充，使其能够支持更灵活的程序组织方式。
