# PPDB 存储设计

## 数据一致性保证

### 写入路径
- **预写日志 (WAL)**
  - 顺序写入以保证持久性
  - 原子批处理操作
  - 同步/异步模式配置
  - 基于段的管理

- **内存表**
  - 并发写入支持
  - 原子更新
  - 版本控制
  - 基于大小的刷新

- **SSTable 生成**
  - 不可变文件格式
  - 排序字符串表结构
  - 块级校验和
  - 索引和布隆过滤器

### 一致性级别
- **强一致性**
  - 同步 WAL 写入
  - 立即 fsync
  - 写入验证

- **最终一致性**
  - 异步 WAL 写入
  - 周期性 fsync
  - 后台验证

### 恢复保证
- **崩溃恢复**
  - WAL 重放
  - 内存表重建
  - 孤立文件清理

## 压缩和合并策略

### 数据压缩
- **压缩算法**
  - LZ4 用于快速压缩
  - ZSTD 用于更好的压缩比
  - 基于数据类型的自适应选择

- **压缩级别**
  - 热数据：最小压缩
  - 温数据：平衡压缩
  - 冷数据：最大压缩

### 合并流程
- **触发条件**
  - 基于大小的触发
  - 基于时间的触发
  - 手动触发

- **选择策略**
  - 大小比例考虑
  - 访问模式分析
  - 文件年龄

- **执行**
  - 后台处理
  - 优先级调度
  - 资源限制

### 存储优化
- **空间回收**
  - 垃圾收集
  - 墓碑清理
  - 过时文件删除

- **文件组织**
  - 基于层级的结构
  - 大小分层
  - 冷热分离

## 内存管理

### 内存分配
- **缓冲池**
  - 大小配置
  - 淘汰策略
  - 预取策略

- **缓存管理**
  - 块缓存
  - 行缓存
  - 索引缓存

### 资源控制
- **内存限制**
  - 每表限制
  - 全局限制
  - 增长限制

- **监控**
  - 使用跟踪
  - 压力检测
  - 告警机制

### 优化
- **内存效率**
  - 紧凑数据结构
  - 指针压缩
  - 内存对齐

- **资源共享**
  - 共享内存池
  - 缓存共享
  - 缓冲区重用

## 实现细节

### 文件格式
- **头部结构**
  - 魔数
  - 版本信息
  - 特性标志

- **数据块**
  - 键编码
  - 值存储
  - 元数据部分

### 索引结构
- **主索引**
  - 稀疏索引
  - 键范围信息
  - 块指针

- **二级索引**
  - 布隆过滤器
  - 摘要信息
  - 缓存提示

## 未来增强
1. 使用混合算法改进压缩比
2. 基于工作负载的智能合并调度
3. 基于机器学习的高级内存管理预测
4. 通过访问模式学习提高缓存效率 