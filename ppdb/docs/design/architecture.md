# PPDB 架构设计

## 概述
PPDB 是一个分布式键值存储系统，注重可靠性、并发性和性能。本文档概述了核心架构决策和机制。

## 错误恢复机制

### 文件系统级恢复
- **原子操作**
  - 关键写入使用 fsync
  - 所有数据修改实现预写日志
  - 维护操作日志用于崩溃恢复

- **损坏检测**
  - 所有数据块使用 CRC32 校验和
  - 文件版本戳记
  - 运行时定期完整性检查

- **恢复流程**
  1. 扫描 WAL 文件查找未提交事务
  2. 验证数据文件完整性
  3. 从最后已知良好状态重建内存表
  4. 应用 WAL 中的待处理事务

### 数据一致性恢复
- **快照机制**
  - 定期创建快照
  - 增量备份支持
  - 时间点恢复能力

- **事务恢复**
  - 两阶段提交协议
  - 事务日志重放
  - 冲突解决策略

## 并发控制

### 无锁操作
- **内存表**
  - 无锁跳表实现
  - 原子更新操作
  - 读一致性的版本控制

- **预写日志**
  - 无锁追加操作
  - 原子段切换
  - 并发读取支持

### 分片策略
- **动态分片**
  - 基于负载的自适应分片大小
  - 自动再平衡
  - 热点检测和缓解

- **分片管理**
  - 一致性哈希分布
  - 分片迁移协议
  - 复制管理

## 文件系统安全

### 路径安全
- **路径验证**
  - 严格路径长度检查
  - 目录遍历防护
  - 字符编码验证

- **访问控制**
  - 文件权限管理
  - 目录所有权验证
  - 安全临时文件处理

### 文件操作
- **安全写入操作**
  - 使用临时文件实现原子写入
  - 修改前创建备份
  - 写入后验证

- **并发访问**
  - 文件锁定机制
  - 读写分离
  - 打开文件句柄管理

### 错误处理
- **操作重试**
  - 指数退避策略
  - 最大重试限制
  - 失败报告机制

- **资源清理**
  - 自动句柄关闭
  - 临时文件清理
  - 锁释放保证

## 性能考虑

### I/O 优化
- **缓冲区管理**
  - 带大小限制的写缓冲
  - 预读缓冲
  - 缓冲区刷新策略

- **磁盘访问**
  - 顺序写入优化
  - 读取模式优化
  - 文件系统对齐

### 内存管理
- **资源限制**
  - 内存使用阈值
  - 缓冲池大小管理
  - 缓存大小控制

- **垃圾回收**
  - 内存回收策略
  - 碎片整理
  - 资源泄漏防护

## 未来改进
1. 使用并行处理增强崩溃恢复
2. 使用自适应大小改进缓冲区管理
3. 使用 MVCC 的高级并发控制
4. 扩展文件系统安全功能 