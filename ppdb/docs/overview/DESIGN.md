# PPDB 设计文档

## 1. 项目愿景

PPDB 的目标是成为一个跨平台、自组织的分布式去中心化数据库系统。主要特点：
- 完全去中心化：无需中心节点，所有节点地位平等
- 自组织网络：节点可以自动发现、加入和退出
- 跨平台支持：基于 Cosmopolitan 实现全平台兼容
- 高可用性：通过多副本和一致性协议保证数据可靠性
- 可扩展性：支持动态添加节点实现水平扩展

## 2. 系统架构

### 2.1 整体架构
```
+------------------------+
|       HTTP API         |
+------------------------+
|    分布式协调层        |
| +-----------------+    |
| |   共识协议(Raft)|    |
| +-----------------+    |
| |   成员管理      |    |
| +-----------------+    |
+------------------------+
|      存储引擎          |
| +-----------------+    |
| | MemTable | WAL  |    |
| +-----------------+    |
| |    SSTable      |    |
| +-----------------+    |
+------------------------+
|      文件系统          |
+------------------------+
```

### 2.2 核心组件

1. 分布式协调层
   - 节点发现和管理
   - Raft 共识协议
   - 数据分片和复制
   - 负载均衡

2. 存储引擎
   - MemTable：内存中的键值存储
   - WAL：持久化日志
   - SSTable：持久化存储
   - LSM树：数据组织结构

## 3. 分布式设计

### 3.1 数据分布
- 使用一致性哈希进行数据分片
- 支持虚拟节点平衡负载
- 自动数据迁移和再平衡
- 多副本策略保证可用性

### 3.2 一致性保证
- 基于 Raft 实现强一致性
- 支持领导选举和日志复制
- 处理网络分区和节点故障
- 提供最终一致性选项

### 3.3 成员管理
- 去中心化的节点发现
- 自动化的成员管理
- 故障检测和自动恢复
- 优雅的节点加入/退出

## 4. 存储引擎

### 4.1 核心组件
1. MemTable
   - 内存中的键值存储
   - 使用跳表实现
   - 支持并发访问

2. WAL(Write-Ahead Log)
   - 持久化日志
   - 故障恢复
   - 数据一致性保证

3. SSTable
   - 持久化存储格式
   - 分层合并策略
   - 索引和布隆过滤器

## 5. 开发路线

### 5.1 第一阶段：单机存储引擎 (MVP)
- 基础存储引擎实现
- HTTP API 接口
- 完整测试覆盖

### 5.2 第二阶段：分布式基础
- 节点发现和管理
- 数据分片
- 基础复制功能

### 5.3 第三阶段：完整分布式支持
- Raft 共识实现
- 自动负载均衡
- 完整分布式功能

## 6. 性能目标

### 6.1 延迟目标
- 读取：P99 < 10ms
- 写入：P99 < 20ms
- 范围查询：P99 < 100ms

### 6.2 吞吐量目标
- 单节点读取：>100K QPS
- 单节点写入：>50K QPS
- 集群可线性扩展

### 6.3 可用性目标
- 服务可用性：99.99%
- 数据持久性：99.999999%
- 自动恢复时间：<30s