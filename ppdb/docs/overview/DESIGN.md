# PPDB 设计概览

> 本文档是 PPDB 系统的整体设计文档，描述了系统架构、核心组件和关键技术选型。它是理解系统的入口文档，其他详细设计文档都基于此展开。相关文档：
> - 各模块详细设计见 `design/` 目录
> - 具体实现规范见 `overview/DEVELOPMENT.md`
> - 构建说明见 `overview/BUILD.md`

# PPDB 设计文档

## 1. 项目愿景

PPDB 的目标是成为一个跨平台、自组织的分布式去中心化数据库系统。主要特点：
- 完全去中心化：无需中心节点，所有节点地位平等
- 自组织网络：节点可以自动发现、加入和退出
- 跨平台支持：基于 Cosmopolitan 实现全平台兼容
- 高可用性：通过多副本和一致性协议保证数据可靠性
- 可扩展性：支持动态添加节点实现水平扩展

## 2. 系统架构

### 2.1 整体架构
```
+------------------------+
|       HTTP API         |
+------------------------+
|    分布式协调层        |
| +-----------------+    |
| |   共识协议(Raft)|    |
| +-----------------+    |
| |   成员管理      |    |
| +-----------------+    |
+------------------------+
|      存储引擎          |
| +-----------------+    |
| | MemTable | WAL  |    |
| +-----------------+    |
| |    SSTable      |    |
| +-----------------+    |
+------------------------+
|      文件系统          |
+------------------------+
```

### 2.2 核心组件
1. 分布式协调层
   - 节点发现和管理
   - Raft 共识协议
   - 数据分片和复制
   - 负载均衡

2. 存储引擎
   - MemTable：内存中的键值存储
   - WAL：持久化日志
   - SSTable：持久化存储
   - LSM树：数据组织结构

## 3. 分布式设计

### 3.1 数据分布
- 使用一致性哈希进行数据分片
- 支持虚拟节点平衡负载
- 自动数据迁移和再平衡
- 多副本策略保证可用性

### 3.2 一致性保证
- 基于 Raft 实现强一致性
- 支持领导选举和日志复制
- 处理网络分区和节点故障
- 提供最终一致性选项

### 3.3 成员管理
- 去中心化的节点发现
- 自动化的成员管理
- 故障检测和自动恢复
- 优雅的节点加入/退出

## 4. 存储引擎设计

### 4.1 同步机制 (sync)
#### 设计目标
- 统一无锁和互斥锁接口
- 支持分片锁优化
- 可配置的自旋和退避策略
- 性能统计和监控

#### 主要组件
```c
typedef struct ppdb_sync_config {
    bool use_lockfree;        // 是否使用无锁模式
    uint32_t stripe_count;    // 分片锁数量
    uint32_t spin_count;      // 自旋次数
    uint32_t backoff_us;      // 退避时间
} ppdb_sync_config_t;
```

#### 性能特性
- 无锁模式：适用于低竞争场景
- 分片锁：减少锁竞争，提高并发度
- 自适应自旋：平衡延迟和CPU使用

### 4.2 跳表实现 (skiplist)
#### 设计目标
- 统一的接口
- 高效的查找
- 内存使用优化
- 完整的迭代器支持

#### 优化特性
- 查找提示缓存
- 内存对齐优化
- 统计信息收集

#### 性能指标
- 插入：O(log N)
- 查找：O(log N)
- 空间复杂度：O(N)

### 4.3 内存表 (memtable)
#### 设计目标
- 基于统一跳表
- 支持布隆过滤器
- 支持压缩
- 支持快照隔离

#### 主要特性
- 布隆过滤器减少不必要的查找
- 可选的值压缩
- 不可变表支持

#### 性能优化
- 写缓冲
- 并发控制
- 内存限制

### 4.4 WAL实现 (wal)
#### 设计目标
- 高性能日志写入
- 数据可靠性
- 快速恢复

#### 优化特性
- 组提交
- 异步刷盘
- 写缓冲池
- CRC校验

#### 性能参数
- 组提交间隔：建议10-50ms
- 写缓冲大小：建议1-4MB
- 异步刷盘：权衡性能和可靠性

## 5. 开发路线

### 5.1 第一阶段：单机存储引擎 (MVP)
- 基础存储引擎实现
- HTTP API 接口
- 完整测试覆盖

### 5.2 第二阶段：分布式基础
- 节点发现和管理
- 数据分片
- 基础复制功能

### 5.3 第三阶段：完整分布式支持
- Raft 共识实现
- 自动负载均衡
- 完整分布式功能

## 6. 性能目标与优化

### 6.1 延迟目标
- 读取：P99 < 10ms
- 写入：P99 < 20ms
- 范围查询：P99 < 100ms

### 6.2 吞吐量目标
- 单节点读取：>100K QPS
- 单节点写入：>50K QPS
- 集群可线性扩展

### 6.3 可用性目标
- 服务可用性：99.99%
- 数据持久性：99.999999%
- 自动恢复时间：<30s

### 6.4 性能调优指南

#### 同步策略选择
- 低竞争：使用无锁模式
- 高竞争：使用分片锁
- 调整分片数：建议为CPU核心数的2-4倍

#### 内存配置
- MemTable大小：根据可用内存的25-40%
- 写缓冲：1-4MB
- 布隆过滤器：权衡内存和误判率

#### WAL优化
- 组提交：高吞吐量场景
- 异步刷盘：低延迟要求
- 同步刷盘：数据安全优先

## 7. 监控指标

### 7.1 性能指标
- 操作延迟
- 吞吐量
- 冲突率
- 缓存命中率

### 7.2 资源使用
- 内存使用
- 磁盘使用
- CPU使用率

### 7.3 异常指标
- 错误率
- 超时次数
- 恢复时间