# PPDB æ¶æ„è®¾è®¡

## 1. æ€»ä½“æ¶æ„

### 1.1 ç³»ç»Ÿå±‚æ¬¡
```
åº”ç”¨å±?
  |
  |-- memkv               diskv
      |                    |
      |                    |
      |                   LSMå­˜å‚¨å¼•æ“
      |                    |-- memtable
      |                    |-- wal
      |                    `-- sstable
      |                    
      `-----> skiplist <----Â´
             (åŸºç¡€ç»„ä»¶)
             - åŸç”Ÿskiplist
             - åˆ†ç‰‡æ”¯æŒ
             - è¿­ä»£å™?



åŸºç¡€å±?(base.c)
â”œâ”€â”€ é”™è¯¯å¤„ç†
â”œâ”€â”€ æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ åŒæ­¥åŸè¯­ (base_sync.inc.c)
â”œâ”€â”€ å†…å­˜åˆ†é…
â””â”€â”€ éšæœºæ•°ç”Ÿæˆ?

å­˜å‚¨å±?(storage.c)
â”œâ”€â”€ é”®å€¼æ“ä½?
â”œâ”€â”€ èŠ‚ç‚¹æ“ä½œ (storage_misc.inc.c)
â”œâ”€â”€ CRUDæ“ä½œ (storage_crud.inc.c)
â””â”€â”€ è¿­ä»£å™¨æ“ä½?(storage_iterator.inc.c)


```

### 1.2 æ ¸å¿ƒç»„ä»¶

#### skiplistï¼ˆåŸºç¡€ç»„ä»¶ï¼?
- æ ¸å¿ƒæ•°æ®ç»“æ„
- æ”¯æŒå¹¶å‘è®¿é—®
- æä¾›åˆ†ç‰‡èƒ½åŠ›
- å®ç°è¿­ä»£å™¨æ¥å?

#### memkvï¼ˆå†…å­˜KVå­˜å‚¨ï¼?
- åŸºäºåˆ†ç‰‡skiplist
- é«˜æ€§èƒ½å†…å­˜å­˜å‚¨
- æ”¯æŒè¿‡æœŸæ—¶é—´
- åè®®å…¼å®¹å±?

#### diskvï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼?
- åŸºäºLSMæ ?
- ä½¿ç”¨skiplistå®ç°memtable
- WALä¿è¯æŒä¹…æ€?
- SSTableåˆ†å±‚å­˜å‚¨

## 2. å…³é”®è®¾è®¡å†³ç­–

### 2.1 ç»Ÿä¸€çš„skiplist
- ä½œä¸ºå…±äº«åŸºç¡€ç»„ä»¶
- æ”¯æŒæ— é”/æœ‰é”ä¸¤ç§æ¨¡å¼
- æä¾›åˆ†ç‰‡èƒ½åŠ›ä»¥æ”¯æŒå¹¶å?
- å¯ç”±memkvå’Œdiskvå¤ç”¨

### 2.2 ç®€åŒ–çš„å±‚æ¬¡ç»“æ„
- å»é™¤å¤šä½™æŠ½è±¡å±?
- ç›´æ¥ä½¿ç”¨å…·ä½“å®ç°
- æ˜ç¡®ç»„ä»¶èŒè´£
- é™ä½ç»´æŠ¤æˆæœ¬

### 2.3 ä¸¤æ¡äº§å“çº?
- memkv: è¿½æ±‚æè‡´æ€§èƒ½
- diskv: ä¿è¯æ•°æ®æŒä¹…æ€?
- å…±äº«åŸºç¡€è®¾æ–½
- ç‹¬ç«‹æ¼”è¿›å‘å±•

## 3. æ¥å£è®¾è®¡

### 3.1 skiplistæ¥å£
```c
typedef struct ppdb_skiplist {
    // åŸºç¡€skiplistç»“æ„
    void* head;
    uint32_t level;
    size_t size;
    
    // åˆ†ç‰‡æ”¯æŒ
    uint32_t shard_bits;
    uint32_t shard_mask;
    
    // å¹¶å‘æ§åˆ¶
    bool use_lock;
    ppdb_sync_t* locks;
    
    // æ€§èƒ½ç»Ÿè®¡
    ppdb_metrics_t metrics;
} ppdb_skiplist_t;
```

### 3.2 memkvæ¥å£
```c
typedef struct ppdb_memkv {
    ppdb_skiplist_t* store;
    ppdb_config_t config;
    ppdb_metrics_t metrics;
} ppdb_memkv_t;
```

### 3.3 diskvæ¥å£
```c
typedef struct ppdb_diskv {
    // å†…å­˜éƒ¨åˆ†
    ppdb_skiplist_t* active;
    ppdb_skiplist_t* imm;
    
    // æŒä¹…åŒ–éƒ¨åˆ?
    ppdb_wal_t* wal;
    ppdb_sstable_t** sst;
    
    // é…ç½®å’Œç»Ÿè®?
    ppdb_config_t config;
    ppdb_metrics_t metrics;
} ppdb_diskv_t;
```

## 4. å…³é”®æµç¨‹

### 4.1 å†™å…¥æµç¨‹
1. memkv
   - ç›´æ¥å†™å…¥åˆ†ç‰‡skiplist
   - æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

2. diskv
   - å†™å…¥WAL
   - å†™å…¥active memtable
   - å¿…è¦æ—¶è§¦å‘compaction

### 4.2 è¯»å–æµç¨‹
1. memkv
   - ä»åˆ†ç‰‡skiplistè¯»å–
   - æ£€æŸ¥è¿‡æœŸæ—¶é—?

2. diskv
   - æŸ¥æ‰¾active memtable
   - æŸ¥æ‰¾immutable memtable
   - æŒ‰å±‚æŸ¥æ‰¾SSTable

### 4.3 compactionæµç¨‹ï¼ˆdiskvï¼?
1. è§¦å‘æ¡ä»¶
   - memtableè¾¾åˆ°é˜ˆå€?
   - æ‰‹åŠ¨è§¦å‘
   - åå°å®šæ—¶è§¦å‘

2. å¤„ç†æ­¥éª¤
   - å†»ç»“å½“å‰memtable
   - åˆ›å»ºæ–°çš„memtable
   - åå°è¿›è¡Œåˆå¹¶
   - æ›´æ–°å…ƒæ•°æ?

## 5. ç›‘æ§æŒ‡æ ‡

### 5.1 skiplistæŒ‡æ ‡
- èŠ‚ç‚¹æ•°é‡
- å†…å­˜ä½¿ç”¨
- æ“ä½œå»¶è¿Ÿ
- åˆ†ç‰‡è´Ÿè½½

### 5.2 memkvæŒ‡æ ‡
- QPSç»Ÿè®¡
- å»¶è¿Ÿåˆ†å¸ƒ
- å†…å­˜ä½¿ç”¨
- è¿‡æœŸç»Ÿè®¡

### 5.3 diskvæŒ‡æ ‡
- å†™æ”¾å¤?
- è¯»æ”¾å¤?
- ç©ºé—´æ”¾å¤§
- compactionç»Ÿè®¡

## 6. åç»­æ¼”è¿›

### 6.1 è¿‘æœŸè§„åˆ’
1. skiplistå¢å¼º
   - å®Œå–„åˆ†ç‰‡æœºåˆ¶
   - ä¼˜åŒ–å¹¶å‘æ§åˆ¶
   - æå‡éå†æ€§èƒ½

2. memkvå¢å¼º
   - æ”¯æŒæ›´å¤šåè®®
   - å¢åŠ é›†ç¾¤åŠŸèƒ½
   - ä¼˜åŒ–è¿‡æœŸæœºåˆ¶

3. diskvå¢å¼º
   - ä¼˜åŒ–compaction
   - æ”¹è¿›ç¼“å­˜ç­–ç•¥
   - å¢åŠ äº‹åŠ¡æ”¯æŒ

### 6.2 é•¿æœŸè§„åˆ’
1. åˆ†å¸ƒå¼æ”¯æŒ?
2. æ›´å¤šå­˜å‚¨å¼•æ“
3. äº‘åŸç”Ÿé€‚é…
4. ç›‘æ§ä½“ç³»å®Œå–„ 

