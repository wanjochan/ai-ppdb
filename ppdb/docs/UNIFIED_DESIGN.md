# PPDB 统一设计文档

## 1. 同步机制 (sync_unified)

### 1.1 设计目标
- 统一无锁和互斥锁接口
- 支持分片锁优化
- 可配置的自旋和退避策略
- 性能统计和监控

### 1.2 主要组件
```c
typedef struct ppdb_sync_config {
    bool use_lockfree;        // 是否使用无锁模式
    uint32_t stripe_count;    // 分片锁数量
    uint32_t spin_count;      // 自旋次数
    uint32_t backoff_us;      // 退避时间
} ppdb_sync_config_t;
```

### 1.3 性能特性
- 无锁模式：适用于低竞争场景
- 分片锁：减少锁竞争，提高并发度
- 自适应自旋：平衡延迟和CPU使用

## 2. 跳表实现 (skiplist_unified)

### 2.1 设计目标
- 统一的接口
- 高效的查找
- 内存使用优化
- 完整的迭代器支持

### 2.2 优化特性
- 查找提示缓存
- 内存对齐优化
- 统计信息收集

### 2.3 性能指标
- 插入：O(log N)
- 查找：O(log N)
- 空间复杂度：O(N)

## 3. 内存表 (memtable_unified)

### 3.1 设计目标
- 基于统一跳表
- 支持布隆过滤器
- 支持压缩
- 支持快照隔离

### 3.2 主要特性
- 布隆过滤器减少不必要的查找
- 可选的值压缩
- 不可变表支持

### 3.3 性能优化
- 写缓冲
- 并发控制
- 内存限制

## 4. WAL实现 (wal_unified)

### 4.1 设计目标
- 高性能日志写入
- 数据可靠性
- 快速恢复

### 4.2 优化特性
- 组提交
- 异步刷盘
- 写缓冲池
- CRC校验

### 4.3 性能参数
- 组提交间隔：建议10-50ms
- 写缓冲大小：建议1-4MB
- 异步刷盘：权衡性能和可靠性

## 5. 构建系统

### 5.1 主程序构建 (build_ppdb.bat)
- 编译源文件
- 创建静态库
- 构建主程序

### 5.2 测试构建 (build_test.bat)
- 编译测试文件
- 构建测试程序
- 自动运行测试

## 6. 性能调优指南

### 6.1 同步策略选择
- 低竞争：使用无锁模式
- 高竞争：使用分片锁
- 调整分片数：建议为CPU核心数的2-4倍

### 6.2 内存配置
- MemTable大小：根据可用内存的25-40%
- 写缓冲：1-4MB
- 布隆过滤器：权衡内存和误判率

### 6.3 WAL优化
- 组提交：高吞吐量场景
- 异步刷盘：低延迟要求
- 同步刷盘：数据安全优先

## 7. 监控指标

### 7.1 性能指标
- 操作延迟
- 吞吐量
- 冲突率
- 缓存命中率

### 7.2 资源使用
- 内存使用
- 磁盘使用
- CPU使用率

### 7.3 异常指标
- 错误率
- 超时次数
- 恢复时间
