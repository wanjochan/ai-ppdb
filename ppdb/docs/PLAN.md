# PPDB 开发计划

> 本文档采用分层架构的方式组织PPDB的开发计划，目的是：
> 1. 清晰展示系统的层次结构：从底层核心组件到上层用户接口
> 2. 明确各层次的职责边界：每层专注于特定的功能领域
> 3. 便于跟踪开发进度：通过分层和模块化的任务列表
> 4. 指导后续开发：保持架构的清晰性和一致性
>
> 文档结构：
> - 第1部分：按照分层架构列出各层组件
> - 第2部分：具体的开发计划和任务
> - 第3部分：项目状态，包括最近更新、当前进展和变更日志
> - 第4部分：文档更新规范和维护原则
>
> 在维护此文档时，请遵循这种分层组织方式，确保架构的清晰性。

## 1. 架构概览

PPDB采用分层架构设计，从底层到上层包括：

### 1.1 核心层 (Core)
基础功能和通用组件：
- [x] 同步原语 (sync)
  - [x] 基础同步类型实现
  - [x] 原子操作封装
  - [ ] 分片锁优化
  - [ ] 引用计数管理
  - 测试：
    * `build.bat sync_locked` - 有锁同步原语测试
    * `build.bat sync_lockfree` - 无锁同步原语测试

- [ ] 内存管理 (memory)
  - [ ] 内存池优化
  - [ ] 资源限制
  - [ ] 垃圾回收

- [x] 错误处理 (error)
  - [x] 错误码定义
  - [x] 错误传播机制
  - 测试：`build.bat test42` - 基础测试框架验证

### 1.2 存储层 (Storage)
数据存储和持久化：
- [x] 跳表实现 (skiplist)
  - [x] 节点内存对齐
  - [x] 原子操作优化
  - [x] 迭代器实现
  - 测试：`build.bat skiplist` - 跳表实现测试

- [ ] 内存表 (memtable)
  - [x] 分片策略完善
  - [ ] 紧凑数据结构
  - [ ] 缓存共享机制
  - [x] 无锁操作接口
  - [x] 内存表满处理机制
  - 测试：
    * `build.bat memtable` - 内存表测试
    * `build.bat sharded` - 分片内存表测试

- [ ] 预写日志 (WAL)
  - [x] 基础写入功能
  - [x] 读取和恢复
  - [ ] 基于段的管理
  - [ ] 压缩和清理
  - [x] 同步/异步配置
  - [x] 无锁操作接口
  - [ ] WAL 同步原语改造
  - 测试：
    * `build.bat wal_core` - WAL核心功能测试
    * `build.bat wal_func` - WAL功能测试
    * `build.bat wal_advanced` - WAL高级特性测试

### 1.3 KV存储层 (KVStore)
键值存储引擎：
- [ ] 基础操作
  - [x] Get/Put/Delete 接口
  - [ ] 批量操作支持
  - [ ] 迭代器优化

- [ ] 高级特性
  - [ ] 事务支持
  - [ ] 快照隔离
  - [ ] 范围查询

- [ ] 内存管理（memkv特性）
  - [ ] 内存使用限制
  - [ ] LRU淘汰策略
  - [ ] 过期时间支持
  - [ ] 内存使用统计

- 测试：
  * `build.bat kvstore` - KV存储引擎测试

### 1.4 构建目标

#### 构建入口
- [ ] ppdb_memkv（第一阶段）
  - [ ] 纯内存KV存储
    - [ ] 高性能无锁实现
    - [ ] 内存限制和淘汰
    - [ ] 过期时间支持
  - [ ] 分布式协调
    - [ ] 节点发现
    - [ ] 一致性哈希
    - [ ] 故障检测
  - [ ] memcached 协议兼容层
    - [ ] 基础命令支持
    - [ ] 二进制协议
    - [ ] 客户端实现
  - 构建命令：`build.bat ppdb_memkv [debug|release]`

- [ ] ppdb（终极目标）
  - [ ] 继承 memkv 全部特性
    - [ ] 内存存储引擎
    - [ ] 分布式协调
    - [ ] 协议兼容
  - [ ] 持久化存储 (diskv)
    - [ ] LSM树实现
    - [ ] 后台合并
    - [ ] 快照机制
  - [ ] 分布式存储
    - [ ] 数据分片
    - [ ] 一致性协议
    - [ ] 故障恢复
  - [ ] 完整功能
    - [ ] 事务支持
    - [ ] 监控系统
    - [ ] 运维工具
  - 构建命令：`build.bat ppdb [debug|release]`

## 2. 开发计划

### 2.1 当前迭代 (2024-Q1-Sprint1)
目标：完成 memkv 核心功能

#### 已完成
- [x] 基础同步原语
- [x] 跳表实现
- [x] 基础KV接口

#### 进行中
- [ ] 无锁 skiplist 优化
  * 内存对齐优化
  * 原子操作改造
  * 性能测试
- [ ] 分片 memtable
  * 分片策略实现
  * 一致性哈希
  * 动态扩缩容

#### 待开始
- [ ] memcached 协议适配
  * 命令解析器
  * 会话管理
  * 客户端SDK

### 2.2 下一步任务

#### 紧急任务
1. memkv核心功能
   - [ ] 完成无锁 skiplist
   - [ ] 实现分片 memtable
   - [ ] 添加内存限制
   - [ ] LRU淘汰实现

2. 分布式协调
   - [ ] 节点管理
   - [ ] 一致性哈希
   - [ ] 故障检测

3. 协议适配
   - [ ] memcached 命令支持
   - [ ] 二进制协议实现
   - [ ] 客户端开发

4. 监控和运维
   - [ ] 基础指标采集
   - [ ] 运维接口
   - [ ] 性能分析工具

#### 待办任务
1. WAL实现（为diskv预留）
2. 持久化支持
3. 分布式一致性
4. 完整事务支持


### 3 文档维护原则
1. 保持文档的实时性和准确性
2. 确保状态、计划和变更的一致性
3. 及时清理过期信息
4. 定期回顾和调整计划
