# PPDB 开发计划

## AI工程师指南
> 这些是每次修改必须遵循的关键指南

### 修改前检查清单
- [x] **文件内容检查**
  - 修改前检查目标文件的完整内容
  - 理解文件的目的和结构
  - 回顾最近的变更及其原因

- [x] **依赖分析**
  - 检查相关头文件中的现有定义
  - 验证包含层次结构和依赖关系
  - 避免在ppdb.h和internal.h之间重复定义
  - 记住我们使用Cosmopolitan libc - 不要包含标准libc头文件

- [x] **架构原则**
  - 保持公共和内部API的清晰分离
  - 遵循现有的模式和命名约定
  - 考虑对其他组件的影响
  - 考虑未来的可扩展性

- [x] **跨平台考虑**
  - 记住我们使用Cosmopolitan实现跨平台支持
  - 不要随意添加平台特定的适配
  - 不要包含Windows特定头文件或libc头文件
  - 使用Cosmopolitan提供的功能

### 开发标准
- [x] **代码质量**
  - 遵循C11标准
  - 保持一致的代码风格
  - 编写清晰的注释
  - 包含错误处理

- [x] **测试**
  - 先写测试
  - 覆盖边缘情况
  - 包含基准测试
  - 测试失败模式

- [x] **文档**
  - 编码时同步写文档
  - 包含示例
  - 解释设计选择
  - 保持文档更新

- [x] **性能**
  - 定期进行性能分析
  - 设置基准
  - 谨慎优化
  - 记录权衡取舍

## 第一阶段：内存KV存储（当前）

### 引擎层
> 专注于构建具有适当抽象的稳固基础

#### 1.1 同步原语
- [x] **指导原则**：实现锁定和无锁版本以进行比较
- [x] 互斥锁和读写锁实现
- [x] 原子操作
- [x] 条件变量
- [x] 信号量
- [x] 性能基准测试（test_sync_perf.c）

#### 1.2 内存管理
- [x] **指导原则**：注重安全性和性能
- [x] 自定义分配器实现
- [x] 内存池
- [x] 引用计数
- [x] 内存泄漏检测

#### 1.3 异步I/O
- [x] **指导原则**：平台特定优化与统一API
- [x] 事件循环（epoll/IOCP）
- [x] 定时器实现
- [x] Future/Promise模式
- [x] 异步原语

### 存储层
> 构建高效的内存数据结构

#### 2.1 跳表
- [x] **指导原则**：平衡复杂性和性能
- [x] 基本实现
- [x] 并发访问
- [x] 内存布局优化
- [x] 迭代器支持

#### 2.2 内存表
- [x] **指导原则**：关注写放大和读性能
- [x] 基本表结构
- [x] 并发操作
- [x] 压缩策略
- [x] 布隆过滤器

#### 2.3 存储接口
- [x] **指导原则**：设计清晰可扩展的API
- [x] 存储实例管理
- [x] 表操作接口
- [x] 索引操作接口
- [x] 基本数据操作（增删改查）
- [x] 统计信息收集
- [x] 配置管理

#### 2.4 分片
- [x] **指导原则**：考虑未来的分布式部署
- [x] 分片策略（test_sharded_memtable.c）
- [x] 数据分布
- [ ] 跨分片操作
- [ ] 重平衡支持

## 第二阶段：持久化层（进行中）

### WAL（预写日志）
> 确保持久性而不牺牲性能

#### 3.1 基本WAL
- [x] **指导原则**：关注写入性能和恢复时间
- [x] 日志格式设计（test_wal_func.c）
- [x] 写入路径优化
- [x] 恢复机制（test_wal_advanced.c）
- [ ] 日志清理

#### 3.2 SSTable
- [ ] **指导原则**：考虑读放大和空间效率
- [ ] 文件格式设计
- [ ] 压缩策略
- [ ] 布隆过滤器
- [ ] 缓存管理

## 第三阶段：分布式层

### 集群管理
> 构建可靠性和可扩展性

#### 4.1 节点管理
- [ ] **指导原则**：设计故障场景
- [ ] 节点发现
- [ ] 健康检查
- [ ] 负载均衡
- [ ] 故障检测

#### 4.2 数据分布
- [ ] **指导原则**：平衡一致性和可用性
- [ ] 分区策略
- [ ] 复制协议
- [ ] 一致性协议
- [ ] 恢复机制

## 测试策略

### 单元测试
- [x] **指导原则**：独立测试每个组件
- [x] 核心原语
- [x] 数据结构
- [x] 存储操作
- [x] 异步操作

### 集成测试
- [x] **指导原则**：测试组件交互
- [x] 端到端工作流
- [x] 故障场景
- [x] 性能基准
- [ ] 压力测试

### 性能测试
- [x] **指导原则**：建立性能基线
- [x] 延迟测量（test_sync_perf.c）
- [x] 吞吐量测试
- [x] 资源利用率
- [ ] 可扩展性测试

## 文档

### 技术文档
- [x] **指导原则**：文档靠近代码
- [x] API文档
- [x] 设计文档
- [x] 性能指南
- [ ] 故障排除指南

### 用户文档
- [ ] **指导原则**：注重可用性
- [ ] 入门指南
- [ ] 配置指南
- [ ] 最佳实践
- [ ] API参考

## 开发流程

### 每个组件的流程
1. **研究阶段**
   - 回顾现有解决方案
   - 确定关键需求
   - 设计API接口

2. **实现阶段**
   - 编写核心功能
   - 添加测试
   - 记录设计决策

3. **优化阶段**
   - 性能分析
   - 识别瓶颈
   - 实施改进

4. **审查阶段**
   - 代码审查
   - 文档审查
   - 性能审查

### 进度跟踪
- 使用RUNNING.md记录会话进度
- 更新CHANGELOG.md用于发布
- 在GitHub上跟踪问题
- 定期进行性能基准测试
