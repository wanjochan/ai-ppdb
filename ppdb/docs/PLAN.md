# PPDB 开发计划

## AI工程师指南
> 这些是每次修改必须遵循的关键指南

### 修改前检查清单
- [x] **文件内容检查**
  - 修改前检查目标文件的完整内容
  - 理解文件的目的和结构
  - 回顾最近的变更及其原因

- [x] **依赖分析**
  - 检查相关头文件中的现有定义
  - 验证包含层次结构和依赖关系
  - 避免在ppdb.h和internal.h之间重复定义
  - 记住我们使用Cosmopolitan libc - 不要包含标准libc头文件

- [x] **架构原则**
  - 保持公共和内部API的清晰分离
  - 遵循现有的模式和命名约定
  - 考虑对其他组件的影响
  - 考虑未来的可扩展性

- [x] **跨平台考虑**
  - 记住我们使用Cosmopolitan实现跨平台支持
  - 不要随意添加平台特定的适配
  - 不要包含Windows特定头文件或libc头文件
  - 使用Cosmopolitan提供的功能

### 开发标准
- [x] **代码质量**
  - 遵循C11标准
  - 保持一致的代码风格
  - 编写清晰的注释
  - 包含错误处理

- [x] **测试**
  - 先写测试
  - 覆盖边缘情况
  - 包含基准测试
  - 测试失败模式

- [x] **文档**
  - 编码时同步写文档
  - 包含示例
  - 解释设计选择
  - 保持文档更新

- [x] **性能**
  - 定期进行性能分析
  - 设置基准
  - 谨慎优化
  - 记录权衡取舍

## 开发阶段与分层架构

base => (engine + storage) => peer => [ppdb.exe] + [ppdb.h,libppdb]

### 第一阶段：内存KV（memkv）
> 实现单机版纯内存键值存储

#### 1.1 基础层（base）
- [x] **指导原则**：构建稳固的底层基础
- [x] 同步原语（互斥锁、读写锁、原子操作）
- [x] 内存管理（内存池、引用计数）
- [x] 异步I/O（事件循环、定时器）
- [x] 错误处理
- [x] 基础工具函数

#### 1.2 引擎层（engine）
- [x] **指导原则**：高效的内存数据结构
- [x] 事务管理
- [x] 并发控制
- [x] MVCC实现
- [x] 异步操作支持

#### 1.3 存储层（storage）
- [x] **指导原则**：可靠的数据管理
- [x] 跳表实现
- [x] 内存表实现
- [x] 基本操作接口（增删改查）
- [x] 统计收集

#### 1.4 服务层（peer + exe）
- [ ] **指导原则**：兼容现有协议
- [ ] 服务器启动/停止（ppdb server）
- [ ] Memcached协议兼容层
- [ ] 基本管理接口
- [ ] 公共API（ppdb.h）

### 第二阶段：命令行工具（CLI）
> 提供强大的管理和操作接口

#### 2.1 基础层扩展
- [ ] **指导原则**：支持脚本执行
- [ ] LISP解释器基础
- [ ] 命令行解析
- [ ] 会话管理

#### 2.2 客户端工具（peer）
- [ ] **指导原则**：便捷的操作体验
- [ ] 远程连接功能
- [ ] 基本命令集
- [ ] 批处理支持

#### 2.3 内置CLI（exe）
- [ ] **指导原则**：高效的本地操作
- [ ] 程序级直连
- [ ] LISP方言解释器
- [ ] 脚本执行环境

### 第三阶段：持久化存储（diskv）
> 增加持久化机制，实现可靠存储

#### 3.1 基础层扩展
- [x] **指导原则**：支持持久化操作
- [x] 文件操作抽象
- [x] IO缓冲管理
- [x] 磁盘空间管理

#### 3.2 引擎层扩展
- [x] **指导原则**：保证数据可靠性
- [x] WAL日志格式设计
- [x] 写入优化
- [x] 恢复机制
- [ ] 日志清理

#### 3.3 存储层扩展
- [ ] **指导原则**：优化读写性能
- [ ] SSTable文件格式
- [ ] 压缩策略
- [ ] 布隆过滤器
- [ ] 缓存管理

### 第四阶段：分布式特性
> 实现去中心化和集群功能

#### 4.1 基础层扩展
- [ ] **指导原则**：支持网络通信
- [ ] 网络协议抽象
- [ ] 序列化支持
- [ ] 安全通信

#### 4.2 引擎层扩展
- [ ] **指导原则**：分布式事务
- [ ] 分布式锁
- [ ] 一致性协议
- [ ] 冲突解决

#### 4.3 节点管理（peer）
- [ ] **指导原则**：可靠的集群管理
- [ ] 节点发现
- [ ] 健康检查
- [ ] 故障检测
- [ ] 负载均衡

#### 4.4 数据分布（storage）
- [ ] **指导原则**：数据可靠性和可用性
- [ ] 分片策略
- [ ] 复制协议
- [ ] 一致性保证

## 测试策略

### 单元测试
- [x] **指导原则**：独立测试每个组件
- [x] 核心原语
- [x] 数据结构
- [x] 存储操作
- [x] 异步操作

### 集成测试
- [x] **指导原则**：测试组件交互
- [x] 端到端工作流
- [x] 故障场景
- [x] 性能基准
- [ ] 压力测试

### 性能测试
- [x] **指导原则**：建立性能基线
- [x] 延迟测量（test_sync_perf.c）
- [x] 吞吐量测试
- [x] 资源利用率
- [ ] 可扩展性测试

## 文档

### 技术文档
- [x] **指导原则**：文档靠近代码
- [x] API文档
- [x] 设计文档
- [x] 性能指南
- [ ] 故障排除指南

### 用户文档
- [ ] **指导原则**：注重可用性
- [ ] 入门指南
- [ ] 配置指南
- [ ] 最佳实践
- [ ] API参考

## 开发流程

### 每个组件的流程
1. **研究阶段**
   - 回顾现有解决方案
   - 确定关键需求
   - 设计API接口

2. **实现阶段**
   - 编写核心功能
   - 添加测试
   - 记录设计决策

3. **优化阶段**
   - 性能分析
   - 识别瓶颈
   - 实施改进

4. **审查阶段**
   - 代码审查
   - 文档审查
   - 性能审查

### 进度跟踪
- 使用RUNNING.md记录会话进度
- 更新CHANGELOG.md用于发布
- 在GitHub上跟踪问题
- 定期进行性能基准测试
