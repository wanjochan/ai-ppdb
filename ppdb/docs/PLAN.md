# PPDB 开发计划

> 本文档采用分层架构的方式组织PPDB的开发计划，目的是：
> 1. 清晰展示系统的层次结构：从底层核心组件到上层用户接口
> 2. 明确各层次的职责边界：每层专注于特定的功能领域
> 3. 便于跟踪开发进度：通过分层和模块化的任务列表
> 4. 指导后续开发：保持架构的清晰性和一致性
>
> 文档结构：
> - 第1部分：按照分层架构列出各层组件
> - 第2部分：具体的开发计划和任务
> - 第3部分：项目状态，包括最近更新、当前进展和变更日志
> - 第4部分：文档更新规范和维护原则
>
> 在维护此文档时，请遵循这种分层组织方式，确保架构的清晰性。

## 1. 架构概览

PPDB采用分层架构设计，从底层到上层包括：

### 1.1 核心层 (Core)
基础功能和通用组件：
- [x] 同步原语 (sync)
  - [x] 基础同步类型实现
  - [x] 原子操作封装
  - [ ] 分片锁优化
  - [ ] 引用计数管理

- [ ] 内存管理 (memory)
  - [ ] 内存池优化
  - [ ] 资源限制
  - [ ] 垃圾回收

- [x] 错误处理 (error)
  - [x] 错误码定义
  - [x] 错误传播机制

### 1.2 存储层 (Storage)
数据存储和持久化：
- [x] 跳表实现 (skiplist)
  - [x] 节点内存对齐
  - [x] 原子操作优化
  - [x] 迭代器实现

- [ ] 内存表 (memtable)
  - [x] 分片策略完善
  - [ ] 紧凑数据结构
  - [ ] 缓存共享机制
  - [x] 无锁操作接口
  - [x] 内存表满处理机制

- [ ] 预写日志 (WAL)
  - [x] 基础写入功能
  - [x] 读取和恢复
  - [ ] 基于段的管理
  - [ ] 压缩和清理
  - [x] 同步/异步配置
  - [x] 无锁操作接口
  - [ ] WAL 同步原语改造

### 1.3 KV存储层 (KVStore)
键值存储引擎：
- [ ] 基础操作
  - [x] Get/Put/Delete 接口
  - [ ] 批量操作支持
  - [ ] 迭代器优化

- [ ] 高级特性
  - [ ] 事务支持
  - [ ] 快照隔离
  - [ ] 范围查询

### 1.4 数据库层 (PPDB)
用户接口和管理功能：
- [ ] 配置管理
  - [ ] 命令行参数
  - [ ] 环境变量
  - [ ] 配置文件（YAML/JSON）
  - [ ] 动态配置重载

- [ ] 监控系统
  - [x] 核心指标定义
  - [ ] Prometheus集成
  - [ ] 告警机制
  - [x] 基础监控接口

## 2. 开发计划

### 2.1 当前迭代 (2024-Q1-Sprint1)
目标：完成 WAL 核心功能和优化

#### 已完成
- [x] WAL 基础功能
  * 写入接口
  * 读取接口
  * 同步机制
- [x] 测试框架改进
  * 测试工具函数
  * 基础测试用例

#### 进行中
- [ ] WAL 高级特性
  * 压缩功能设计
  * 清理机制优化
  * 性能测试用例

#### 待开始
- [ ] 批量操作支持
  * 批量写入接口
  * 批量读取优化
  * 并发性能测试

### 2.2 下一步任务

#### 紧急任务
1. 完善存储层
   - [ ] WAL 同步原语改造
   - [ ] 实现无锁版本函数
   - [ ] 内存表优化

2. 开发KV存储层
   - [ ] 实现批量操作
   - [ ] 完善事务支持
   - [ ] 优化查询性能

3. 构建数据库层
   - [ ] 实现配置管理
   - [ ] 完善监控系统
   - [ ] 添加管理接口

#### 待办任务
1. 实现压缩模块
2. 添加性能基准测试
3. 完善集成测试
4. 实现分片锁优化

## 3. 项目状态

### 3.1 最近更新 (最近3天)
- [2024-01-01] 完成 WAL 基础功能实现
- [2024-01-01] 修复 memtable 并发问题
- [2024-01-01] 添加测试工具函数 (test_utils.h/c)

### 3.2 当前阶段
- 正在实现：WAL 高级特性
- 待解决问题：3个
  1. WAL 压缩功能待实现
  2. WAL 清理机制待优化
  3. 批量写入接口待完善
- 阻塞事项：无

### 3.3 变更日志
#### 未发布
- 新增
  * WAL 基础功能实现（写入、读取、同步）
  * 测试工具函数库（日志、文件操作、随机数据生成等）
- 修复
  * memtable 并发问题
  * 测试框架缺失的头文件问题
- 优化
  * 改进日志系统
  * 完善测试框架

## 4. 文档更新规范

### 4.1 文档更新检查清单
每次代码变更后，需要更新以下内容：
1. 更新"最近更新"和"当前阶段"
2. 在"变更日志"中记录变更
3. 更新架构概览中的任务完成状态
4. 更新当前迭代的任务状态
5. 调整下一步任务的优先级

### 4.2 文档维护原则
1. 保持文档的实时性和准确性
2. 确保状态、计划和变更的一致性
3. 及时清理过期信息
4. 定期回顾和调整计划
