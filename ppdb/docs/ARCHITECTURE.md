# PPDB 架构设计

## 项目结构

```
ppdb/
├── include/
│   └── ppdb.h         # 唯一的公共头文件
├── test/              # 测试目录
├── src/
│   ├── internal/      # 内部实现头文件
│   │   ├── base.h     # 基础设施
│   │   ├── engine.h   # 引擎核心
│   │   ├── storage.h  # 存储系统
│   │   └── peer.h     # 节点管理
│   ├── base/          # 基础设施实现
│   ├── base.c
│   ├── engine/        # 引擎核心实现
│   ├── engine.c
│   ├── storage/       # 存储系统实现（libppdb）
│   ├── storage.c
│   ├── peer/         # 各种服务端/客户端实现
│   └── peer.c
└── ppdb.c            # 主程序入口（启动 Server、CLI、网络接口、分布式网络与节点）
```

## 分层架构

PPDB 采用清晰的分层架构设计，每一层都有其明确的职责和边界：

base => engine => storage => peer => [ppdb.exe] + [ppdb.h,libppdb]

1. **基础层** (`base.h/c`)
   - 内存管理
   - 日志系统
   - 同步原语
   - 通用工具函数

2. **引擎层** (`engine.h/c`)
   - 事务管理
   - 并发控制
   - MVCC 实现
   - 异步操作支持

3. **存储层** (`storage.h/c`)
   - 存储引擎实现
   - 数据组织结构
   - 持久化管理
   - 缓存管理

4. **节点层** (`peer.h/c`)
   - 集群管理
   - 节点间通信
   - 一致性协议
   - 分布式事务

5. **公共 API 层** (`ppdb.h`)
   - 对外提供统一的接口
   - 这是用户唯一需要包含的头文件
   - 隐藏内部实现细节

## 模块职责

每个头文件都有其特定的职责：

- **base.h**：基础工具函数（内存、日志、工具等）
- **engine.h**：引擎层核心功能实现（事务、并发控制等）
- **storage.h**：存储引擎实现（数据组织、持久化等）
- **peer.h**：节点管理实现（集群、通信等）
- **ppdb.h**：公共 API，提供简洁统一的接口

## 设计原则

1. **层次分明**
   - 每一层只能调用其下层的接口
   - 禁止跨层调用
   - 避免循环依赖

2. **接口清晰**
   - 每个模块都有明确定义的公共接口
   - 内部实现细节对外不可见
   - 接口设计要简洁易用

3. **职责单一**
   - 每个模块只负责一个核心功能
   - 避免功能重叠
   - 保持高内聚低耦合

4. **可测试性**
   - 所有公共接口都要有对应的测试
   - 支持单元测试和集成测试
   - 保证代码质量和可维护性
