# Poly 层命令行框架开发计划


## 核心目标
实现一个简洁的命令行框架，支持以下核心功能：
1. 命令注册：允许各模块注册自己的命令
2. 命令分发：解析并执行 ppdb.exe <cmd> 格式的命令
3. 帮助系统：自动生成命令帮助信息

## 背景

特别注意！！ 要看 ppdb/docs/DESIGN.md 文件，里面有 ppdb 项目架构的说明。

PPDB 项目重构为三层架构：
- infra（原子层）：基础设施
- poly（聚合物层）：功能组件
- peer（细胞层）：产品实现

需要在 poly 层实现命令行框架，支持 ppdb.exe <cmd> 模式。

## 目标命令
1. help：帮助信息
2. server：PPDB 服务器，支持 --feature 选项
3. cli：客户端
4. riinetd：rinetd 替代
5. ws：WebSocket 代理
6. fetcher：多点下载工具

## 开发步骤

### 第一阶段：基础框架
1. 实现 cmdline 组件
   - [x] cmdline.h：接口定义
   - [x] cmdline.c：基本实现
   - [ ] 单元测试
   - [ ] 集成到 ppdb.c

2. 实现 help 命令
   - [ ] 基本帮助信息
   - [ ] 命令详细说明
   - [ ] 选项说明

### 第二阶段：命令实现
1. server 命令
   - [ ] 基本框架
   - [ ] feature 选项
   - [ ] 服务管理

2. cli 命令
   - [ ] 基本框架
   - [ ] 交互模式
   - [ ] 命令处理

3. riinetd 命令
   - [ ] 基本框架
   - [ ] 配置处理
   - [ ] 代理功能

4. ws 命令
   - [ ] 基本框架
   - [ ] WebSocket 支持
   - [ ] 进程池管理

5. fetcher 命令
   - [ ] 基本框架
   - [ ] 多点下载
   - [ ] 续传支持

## 技术要点
1. 命令注册机制
2. 参数解析
3. 帮助系统
4. 错误处理
5. 资源管理

## 测试计划
1. 单元测试
   - 命令注册
   - 参数解析
   - 帮助显示

2. 集成测试
   - 命令执行流程
   - 错误处理
   - 资源清理

## 注意事项
1. 保持接口简洁
2. 错误处理完整
3. 内存管理安全
4. 代码风格一致
5. 文档及时更新

## 依赖
1. infra 层
   - infra_printf
   - infra_error_t

2. cosmopolitan
   - 基础类型
   - 字符串处理

## 时间节点
1. 基础框架：2天
2. help 命令：1天
3. 其他命令：每个2-3天
4. 测试和完善：2天

## 验收标准
1. 所有计划功能完整实现
2. 测试覆盖率达到要求
3. 代码符合项目规范
4. 文档完整且准确 