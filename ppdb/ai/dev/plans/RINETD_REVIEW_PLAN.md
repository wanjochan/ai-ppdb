# RINETD 模块代码审查计划

## 项目背景

PPDB(Peer Port Database)是一个端口转发和管理工具,

项目文档时 ppdb/docs/DESIGN.md

系统设计采用分层架构:

- infra 层: 提供基础设施,如网络、线程、同步等功能
- poly 层: 提供命令行框架
- peer 层: 提供具体功能实现

rinetd 模块位于 peer 层,负责端口转发功能的实现。

## 审查重点

### 1. 架构合规性
- 是否遵循 infra/poly/peer 分层规范
- 是否正确使用 infra 层的网络和线程接口
- 是否通过 poly 层的命令行框架提供功能

### 2. 核心功能完整性
- 配置管理: 加载/保存转发规则
- 服务控制: 启动/停止/状态查询
- 端口转发: 监听/连接/数据转发
- 会话管理: 创建/清理/统计

### 3. 关键机制
- 线程安全: 共享数据保护、死锁预防
- 资源管理: 套接字/内存的分配和释放
- 错误处理: 参数检查、错误日志、异常恢复

### 4. 代码质量
- 接口设计: 参数和返回值的合理性
- 实现细节: 命名规范、注释完整性
- 可维护性: 代码结构、复杂度控制

## 主要相关文件

- `peer_rinetd.h`: 模块接口定义
- `peer_rinetd.c`: 模块实现代码
- `infra_net.h`: 网络操作接口
- `poly_cmdline.h`: 命令行框架接口

## 注意事项

1. rinetd 模块不允许修改 infra 层代码
2. 这是 peer层模块，只允许调用 infra 和 poly 层的接口，如果不够，停下来请求。


## 审查结论（由智能助理审查后回填）

```
⚠️ 存在的问题：
数据转发只实现了单向（从源到目标），需要实现双向转发
缺少连接超时处理
缺少错误重试机制

潜在风险：
cleanup_forward_session 中的互斥锁使用范围过小，可能导致竞态条件
会话清理时没有确保数据完全发送完成
remove_session_from_list 实现不完整，可能导致会话列表混乱

续改进建议：
添加连接超时机制
实现错误重试
完善会话统计功能

```

用户意见：

【  】先完成双向转发
【  】添加连接超时机制
【  】实现错误重试
【  】优化会话管理（修复 remove_session_from_list 实现不完善的问题、修复 cleanup_forward_session 中的竞态条件问题）
【  】完善会话统计功能
