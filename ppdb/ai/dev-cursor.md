# AI开发模式说明

## 1. 角色定义与职责

### 1.1 PM-Cursor
- 任务规划和分配
- 架构和重构决策
- 进度监控和协调
- 代码审查
- 风险管理

### 1.2 DEV实例
- 严格执行指定任务
- 不进行未授权的重构
- 保持状态更新
- 记录新发现和建议
- 文件操作约束：
  - 新建文件前必须先阅读设计文档
  - 严格遵守项目的目录结构规范
  - 必须在正确的目录层级进行操作
  - 新文件命名必须符合项目规范
  - 对现有文件的修改需先确认其位置正确性
- 代码删除约束：
  - 严禁删除与任务无关的代码
  - 删除代码前必须仔细分析其职责和依赖
  - 对于不确定的代码必须保留并报告
  - 每次删除操作必须有明确的任务依据
  - 删除前必须做好备份和记录
  - 重要模块的代码删除需二次确认

### 1.3 职责边界
- DEV不做任务范围外的修改
- DEV不自主进行架构调整
- 改进建议通过状态报告提交
- 架构变更必须通过正式任务

## 2. 任务管理

### 2.1 任务定义规范
```json
{
    "task_id": "001",
    "type": "code_implementation",
    "description": "任务描述",
    "priority": "high/medium/low",
    "steps": [],
    "constraints": [],
    "success_criteria": []
}
```

### 2.2 任务重启规范
- 清理要求：
  - 删除旧的日志文件（logs/task_xxx.log）
  - 删除旧的状态文件（status/task_xxx.json）
  - 确保工作目录干净
  - 验证相关文件已恢复到正确状态
- 重启流程：
  1. 执行清理
  2. 确认任务定义文件正确
  3. 重新开始执行任务

### 2.3 任务粒度控制
- 功能独立性：专注单一功能
- 影响范围：1-3个核心文件
- 完成时间：不超过4小时
- 测试复杂度：范围明确可控

### 2.4 状态报告规范
```json
{
    "type": "status_report",
    "task_id": "001",
    "status": "in_progress",
    "progress": "80%",
    "findings": {
        "suggestions": [],
        "issues": []
    }
}
```

## 3. 多DEV协作

### 3.1 任务分配原则
- 按模块划分任务
- 避免多DEV修改同一文件
- 明确任务依赖关系
- 设置合理优先级

### 3.2 质量控制
- 统一代码规范
- 完整测试要求
- 严格审查流程
- 文档标准

## 4. 经验总结

### 4.1 成功经验
- 任务拆分合理
- 职责边界清晰
- 监控机制完整
- 改进流程规范

### 4.2 失败教训
- 避免任务过大
- 防止跨模块污染
- 控制修改范围
- 防止未授权重构
- 禁止自行创建新模块：
  - 案例：在task003执行过程中，DEV擅自创建infra_string模块
  - 问题1：未经授权擅自创建模块
  - 问题2：未阅读设计文档就进行操作
  - 问题3：在错误的目录位置创建文件
  - 影响：
    - 破坏项目架构的统一管理
    - 导致模块职责混乱
    - 依赖关系复杂化
    - 目录结构混乱
  - 正确做法：
    1. 先阅读项目设计文档
    2. 确认正确的目录结构
    3. 在状态报告中提出创建建议
    4. 等待PM决策后执行
- 防止过度删除代码：
  - 案例：在task003执行过程中，DEV在迁移内存管理代码时，错误地删除了infra_core中与内存无关的代码
  - 问题：
    1. 未仔细识别代码职责
    2. 过度解释任务范围
    3. 粗暴的代码迁移方式
  - 影响：
    - 破坏了模块的其他功能
    - 增加了代码恢复的工作量
    - 可能导致系统不稳定
  - 正确做法：
    1. 仔细分析每段代码的职责
    2. 只迁移确定相关的代码
    3. 迁移前做好代码备份
    4. 增量式迁移并及时测试

### 4.3 改进建议处理
1. DEV记录发现和建议
2. PM评估价值和风险
3. 创建专门任务
4. 按流程执行改进 

## 附录A：通信协议详细定义

### A.1 任务定义完整格式
```json
{
    "task_id": "001",
    "type": "code_implementation",
    "description": "任务描述",
    "priority": "high/medium/low",
    "project_context": {
        "root_dir": "项目根目录",
        "source_dir": "源码目录",
        "test_dir": "测试目录",
        "scripts_dir": "脚本目录"
    },
    "reporting": {
        "required": true,
        "interval": "per_step",
        "files": {
            "log": "日志文件路径",
            "status": "状态文件路径"
        }
    },
    "steps": [
        {
            "step": 1,
            "action": "动作描述",
            "tool": "使用的工具",
            "params": {
                "参数1": "值1"
            },
            "log_required": {
                "before": "执行前日志模板",
                "during": "执行中日志模板",
                "after": "执行后日志模板",
                "details": "详细信息模板"
            }
        }
    ],
    "constraints": [],
    "success_criteria": []
}
```

### A.2 状态报告完整格式
```json
{
    "type": "status_report",
    "task_id": "001",
    "timestamp": "2024-01-11T10:30:00Z",
    "status": "in_progress",
    "current_step": 2,
    "start_time": "2024-01-11T10:00:00Z",
    "last_update": "2024-01-11T10:30:00Z",
    "progress": "80%",
    "steps_completed": [1],
    "current_action": "正在执行的动作",
    "findings": {
        "suggestions": [],
        "issues": [],
        "improvements": {}
    }
}
```

### A.3 错误报告格式
```json
{
    "type": "error_report",
    "task_id": "001",
    "timestamp": "2024-01-11T10:35:00Z",
    "error_type": "compilation_error",
    "severity": "high/medium/low",
    "details": "错误详情",
    "stack_trace": "错误堆栈",
    "context": {
        "file": "出错文件",
        "line": "行号",
        "function": "函数名"
    },
    "impact": "影响范围",
    "suggested_action": "建议的解决方案"
}
```

## 附录B：文件结构与命名规范

### B.1 目录结构
```
ppdb/ai/
├── dev/                # 开发相关文件
│   ├── tasks/         # 任务定义文件
│   │   └── task{编号}.txt    # 如：task001.txt
│   ├── logs/          # 执行日志
│   │   └── task_{编号}.log   # 如：task_001.log
│   └── status/        # 状态文件
│       └── task_{编号}.json  # 如：task_001.json
└── dev-cursor.md      # 本说明文档
```

### B.2 日志格式规范
```
[时间戳] [步骤编号] [动作类型] 具体内容
示例：[2024-01-11T10:30:00Z] [1] [代码分析] 开始分析文件结构
```

## 附录C：操作流程细则

### C.1 异常处理流程
1. **日志缺失**：
   - 检测间隔：5分钟
   - 处理方式：标记为waiting_for_update
   - 通知机制：状态文件更新

2. **任务超时**：
   - 预警点：预期时间50%
   - 干预点：预期时间100%
   - 处理方式：暂停并评估

3. **代码冲突**：
   - 发现时：立即暂停
   - 记录：详细的冲突信息
   - 解决：PM介入协调

### C.2 代码审查清单
1. **基础检查**：
   - 代码格式规范
   - 必要的注释
   - 测试覆盖
   - 文档更新

2. **功能验证**：
   - 功能完整性
   - 边界条件
   - 错误处理
   - 性能指标

3. **安全检查**：
   - 内存管理
   - 并发处理
   - 输入验证
   - 错误处理

### C.3 测试要求
1. **单元测试**：
   - 覆盖率 > 90%
   - 边界测试
   - 异常测试

2. **集成测试**：
   - 模块间交互
   - 性能测试
   - 并发测试

## 附录D：性能指标

### D.1 响应时间
- 任务确认：< 1分钟
- 状态更新：< 5分钟
- 异常响应：< 2分钟

### D.2 质量指标
- 代码覆盖率：> 90%
- 内存泄漏：0
- 并发安全：100%
- 向后兼容：100% 