# Cosmo动态加载器

## 项目目标

利用Cosmopolitan工具链，实现一个轻量级的动态加载器，用于加载和执行特定格式的动态库文件。该项目是PPDB（跨平台动态库模块）的一个组成部分。

### 核心目标
1. 实现基于ELF格式的动态库加载机制
2. 支持基本的符号解析和重定位
3. 提供类似dlopen/dlsym的动态加载接口
4. 确保与Cosmopolitan工具链的兼容性

### 设计思路
1. 使用简化的ELF格式作为动态库格式
2. 实现必要的重定位类型支持
3. 提供生命周期管理接口（init/main/fini）
4. 支持GOT/PLT机制以实现外部函数调用

## 项目进度

### 已完成功能
1. 基本的ELF文件加载和解析
2. 符号表处理和符号查找
3. 基本的重定位处理（R_X86_64_64、R_X86_64_32、R_X86_64_PC32等）
4. 生命周期管理（dl_init、dl_main、dl_fini）
5. GOT表的初步实现

### 当前问题
1. GOT重定位处理仍有问题，特别是对于未定义符号的处理
2. 程序在执行某些外部函数调用时会发生段错误

### 下一步计划
1. 完善GOT重定位处理机制
2. 实现更健壮的外部符号解析和调用机制
3. 添加更多的重定位类型支持
4. 改进错误处理和调试信息输出

## 注意事项

1. 代码修改
   - 修改重定位处理时需要特别小心，确保不破坏现有的功能
   - 保持代码的清晰结构，添加必要的注释
   - 对于关键的数据结构修改，需要同步更新相关的处理逻辑

2. 编译和链接
   - 使用`build_dl.bat`进行编译
   - 确保链接脚本(`dl.lds`)正确配置了所有必要的段
   - 注意保持正确的段对齐

3. 测试
   - 使用`test10.c`作为主要测试用例
   - 需要关注外部函数调用的正确性
   - 重点测试GOT相关功能

4. 调试建议
   - 使用`dprintf`输出详细的调试信息
   - 关注重定位过程中的地址计算
   - 检查符号解析和GOT表项的正确性

## 代码结构

### 主要组件
1. 加载器核心（cosmo.c）
   - ELF文件解析
   - 重定位处理
   - 符号解析
   - GOT表管理

2. 链接脚本（dl.lds）
   - 段的布局和对齐
   - GOT/PLT段的配置

3. 测试用例（test10.c）
   - 基本功能测试
   - 外部函数调用测试

### 关键数据结构
1. `struct load_info`：加载信息
2. `struct got_entry`：GOT表项
3. ELF相关结构（Elf64_Ehdr、Elf64_Shdr等）

## 已知限制
1. 目前仅支持x86_64架构
2. 外部符号解析能力有限
3. 错误恢复机制需要改进
4. GOT/PLT机制尚未完全实现

## 参考资料
1. ELF规范文档
2. x86_64 ABI文档
3. 动态链接器实现指南 