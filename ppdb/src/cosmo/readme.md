# PPDB 跨平台动态库模块

## 项目目标

利用 Cosmopolitan 工具链，实现能同时被 Windows/Linux/macOS 原生加载器和 cosmo_dlxxxx 系列函数加载的动态库。

最新思路

```
像编译 APE 可执行文件一样编译，但使用我们的 dl.lds 编译出来的 xxxx.dl
修改 ape_loader 来加载这个特殊格式的文件来运行
本质上是个 APE 文件
```

## 当前进展

- 已有初步的链接脚本（dll.lds）
- 已定义基本的导出符号（exports.txt）
- 已实现基本的内存布局设计

## 核心思路

1. **构建目标**
   - 使用 Cosmopolitan 工具链构建动态库
   - 确保生成的文件同时符合：
     * Windows DLL 格式
     * Linux SO 格式
     * macOS DYLD 格式

2. **加载方式**
   - 通过 cosmo_dlopen/cosmo_dlsym 等函数加载（首选）
   - 也可通过各平台原生的 dlopen/LoadLibrary 加载
   - 保证 ABI 兼容性

3. **内存布局**
   - 基地址：0x220000000（参考 dll.lds）
   - 代码段（R-X）和数据段（RW-）分离
   - 支持导出符号表

## 实现计划

1. **第一阶段**
   - 完善现有的链接脚本
   - 实现基本的导出函数
   - 验证 cosmo_dlxxxx 加载

2. **第二阶段**
   - 验证各平台原生加载器兼容性
   - 完善符号导出机制
   - 添加版本控制支持

3. **第三阶段**
   - 优化内存布局
   - 实现更多功能性导出
   - 提供完整的示例

## 关键文件

- `dll.lds`: 链接脚本，定义内存布局
- `exports.txt`: 导出符号定义
- `*.c`: 实现文件
- `build_*.bat`: 构建脚本

## 注意事项

1. **构建要求**
   - 使用 Cosmopolitan 工具链
   - 遵循导出符号规范
   - 保持 ABI 兼容性

2. **使用限制**
   - 固定的基地址加载
   - 特定的符号导出方式
   - 平台特定的限制

3. **调试建议**
   - 使用 cosmo_dlxxxx 进行初期测试
   - 分别验证各平台原生加载
   - 注意符号可见性问题 