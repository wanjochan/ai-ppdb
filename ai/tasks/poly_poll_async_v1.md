# poly_poll_async 第一版实现计划

## 目标
实现一个基于 infra_async 的最小可用版本的异步轮询服务。

## 当前状态
- infra_async 提供基础协程功能：创建、让出、运行
- poly_poll_async 需要简化以配合当前的 infra_async

## 实现步骤

### 1. 简化数据结构
- 移除复杂的调度器实现
- 保留必要的线程上下文
- 简化协程管理结构

### 2. 调整核心功能
- 监听器协程：处理新连接
- 客户端协程：处理单个连接
- 线程工作函数：运行协程调度器

### 3. 内存管理
- 确保资源正确分配和释放
- 处理内存分配失败的情况
- 实现清理函数

### 4. 错误处理
- 完善错误检查
- 添加基本的错误日志
- 实现优雅退出

## 具体修改

### poly_poll_async.h
```c
typedef struct thread_scheduler {
    int thread_id;                // 线程ID
    void* user_data;              // 用户数据（指向context）
} thread_scheduler_t;
```

### poly_poll_async.c
1. handle_client 函数
   - 处理单个客户端连接
   - 释放资源后退出

2. handle_listener 函数
   - 接受新连接
   - 创建客户端处理协程
   - 处理资源分配失败

3. thread_worker 函数
   - 简单运行协程调度器
   - 无任务时短暂休眠

4. 初始化和清理
   - 分配必要资源
   - 启动工作线程
   - 正确清理资源

## 测试计划
1. 基本功能测试
   - 启动/停止服务
   - 接受连接
   - 处理数据
   - 关闭连接

2. 压力测试
   - 多客户端连接
   - 快速连接/断开
   - 长连接保持

3. 错误处理测试
   - 内存分配失败
   - 网络错误
   - 服务关闭

## 后续优化（待 infra_async 完善后）
1. 添加协程池
2. 实现工作窃取
3. 改进调度策略
4. 添加监控统计 