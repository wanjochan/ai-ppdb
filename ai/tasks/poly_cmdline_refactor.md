# Poly Cmdline 重构计划

## 问题分析

1. 当前问题
   - 命令行参数处理不够灵活，不支持乱序参数
   - 配置分散在多个文件中
   - 服务转发配置不统一

2. 目标
   - 支持统一的配置文件格式
   - 支持灵活的命令行参数顺序
   - 实现统一的服务转发配置

## 设计方案

### 1. 配置文件格式

```conf
# 服务转发配置
127.0.0.1  8018  127.0.0.1 8080          # rinetd forward
127.0.0.1  5433  sqlite file::memory:?cache=shared  # sqlite forward
127.0.0.1  11211 memkv  sqlite::memory:?cache=shared  # memcached protocol
127.0.0.1  5432  diskv  sqlite:./diskv.db  # redis protocol
```

### 2. 命令行接口

```bash
exe start --config=./ppdb.conf --log-level=5
exe --config=./ppdb.conf stop --log-level=3
```

### 3. 重构步骤

1. 修改 poly_cmdline 模块 ✅
   - 重构参数解析逻辑 ✅
   - 添加配置文件解析功能 ✅
   - 实现全局配置管理 ✅

2. 服务转发配置
   - 统一配置格式 ✅
   - 实现配置解析器 ✅
   - [ ] 更新服务启动逻辑

3. 测试计划
   - [ ] 编写单元测试
   - [ ] 进行集成测试
   - [ ] 性能测试

## 执行计划

1. Phase 1: 基础重构 ✅
   - 重构 poly_cmdline.h 接口 ✅
   - 实现新的参数解析逻辑 ✅
   - 添加配置文件解析功能 ✅

2. Phase 2: 服务配置
   - 实现统一配置解析器 ✅
   - [ ] 更新服务启动逻辑
   - [ ] 整合现有服务模块

3. Phase 3: 测试与验证
   - [ ] 编写单元测试
   - [ ] 进行集成测试
   - [ ] 性能测试

## 风险评估

1. 兼容性风险
   - 现有配置迁移：需要提供迁移工具
   - API 变更影响：已通过新的接口设计解决

2. 性能风险
   - 配置解析开销：通过缓存配置减少解析次数
   - 服务启动延迟：保持最小化配置解析开销

## 后续计划

1. 监控与日志
   - [ ] 添加配置解析的详细日志
   - [ ] 添加服务启动状态监控

2. 文档更新
   - [ ] 更新配置文件格式文档
   - [ ] 更新命令行使用说明

3. 性能优化
   - [ ] 配置文件缓存机制
   - [ ] 服务启动并行化 