<!DOCTYPE html>
<html>
<head>
    <title>任务监控</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        th {
            background: #f0f0f0;
        }
        .status-unread { color: blue; }
        .status-processing { color: orange; }
        .status-completed { color: green; }
        .status-archived { color: gray; }
        .connection-status {
            padding: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>任务监控</h1>
    <div id="connection-status" class="connection-status">连接中...</div>
    <div id="tasks-table"></div>

    <script>
        let ws = null;
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host + '/ws');
            
            ws.onopen = () => {
                document.getElementById('connection-status').textContent = '已连接';
                document.getElementById('connection-status').style.color = 'green';
            };
            
            ws.onclose = () => {
                document.getElementById('connection-status').textContent = '已断开，正在重连...';
                document.getElementById('connection-status').style.color = 'red';
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateTasksTable(data.data);
            };
        }
        
        function updateTasksTable(data) {
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>角色</th>
                    <th>未读</th>
                    <th>处理中</th>
                    <th>已完成</th>
                    <th>已归档</th>
                </tr>
            `;
            
            for (const role in data) {
                const inbox = data[role].inbox;
                table.innerHTML += `
                    <tr>
                        <td>${getRoleDisplayName(role)}</td>
                        <td class="status-unread">${inbox.unread}</td>
                        <td class="status-processing">${inbox.processing}</td>
                        <td class="status-completed">${inbox.completed}</td>
                        <td class="status-archived">${inbox.archived}</td>
                    </tr>
                `;
            }
            
            const container = document.getElementById('tasks-table');
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        function getRoleDisplayName(role) {
            const names = {
                'User': '用户',
                'PM': '项目经理',
                'Dev': '开发者'
            };
            return names[role] || role;
        }
        
        // 启动WebSocket连接
        connectWebSocket();
        
        // 保持连接活跃
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('ping');
            }
        }, 30000);
    </script>
</body>
</html>
