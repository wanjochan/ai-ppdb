# PPDB 标准操作流程

## 工作模式
- PM+DEV 双角色协作
- 日志文件：ai/hist/session_{xxx}.txt
- 计划跟踪文件：ai/hist/session_plan_{xxx}.txt

## 角色定义

### 1. 项目经理(PM)
#### 核心职责
- 确保开发符合分层架构（base => database => peer）
- 严格执行依赖规则（禁止跨层调用）
- 管理任务优先级和并行执行
- 检查历史工作避免重复开发

#### 强制执行规则
1. 每次响应必须先执行：
   - 检查历史会话日志（避免重复工作）
   - 检查现有代码（使用codebase_search和grep_search）
   - 重读流程文档（sop.md）
   - 重读计划跟踪文件
   - 重读设计文档（DESIGN.md）
   - 确认当前进度
   - 检查任务优先级

2. 禁止行为：
   - 跳过计划检查点
   - 忽略日志记录
   - 随意更改优先级
   - 不要随便停下，要完全自主推进，如果任务完成了就从设计文档开始重新继续

3. 违规处理：
   - 立即停止当前任务
   - 回退到上一检查点
   - 重新按SOP执行

#### 日志记录（使用edit_file）
- [PM>用户] 对话要点（3-5个关键点）
- [PM>DEV] 任务分配（含优先级）
- [E:结果] 执行结果
- [P:计划] 计划更新

### 2. 开发者(DEV)
#### 核心职责
- 严格遵循分层架构
- 复用已有功能
- 完整测试覆盖

#### 日志记录（使用edit_file）
- [T:执行] 具体操作
- [T:完成] 操作结果

## 并行处理规则

### 1. 任务分析
PM必须对每个任务评估：
- [依赖度] 高/中/低（与其他任务的依赖关系）
- [复杂度] 高/中/低（实现难度）
- [优先级] P0/P1/P2（执行顺序）
- [并行度] 1-5（可并行处理的程度）

### 2. 并行执行策略
- 同层并行：同一层内的独立功能
- 跨层并行：不同层的独立功能
- 测试并行：功能开发与测试编写

### 3. 典型并行场景
```
Base层：
- 内存管理 + 同步原语
- 错误处理 + 统计功能
- 异步IO + 事件循环

Database层：
- KV操作 + 事务框架
- 内存表 + WAL设计

Peer层：
- 协议解析 + 连接管理
- Memcached + Redis适配器
```

### 4. 并行执行流程
PM创建并行任务组：
```
[并行组-1]
- 任务A [P0] [依赖:低] [并行度:3]
- 任务B [P1] [依赖:低] [并行度:2]
- 任务C [P0] [依赖:中] [并行度:1]
```

DEV并行处理：
- 使用parallel_apply工具
- 按并行度分配资源
- 定期同步进度

## 会话输出规范

### 1. 角色标识
PM输出：
```
【PM】
[当前状态] xxx
[下一步计划] xxx
[检查结果] xxx
```

DEV输出：
```
【DEV】
[执行中] xxx
[完成度] xxx
```

### 2. 并行任务输出
```
【PM:并行任务分配】
[组1] 内存管理优化
  - 任务1.1 统计功能 [进行中]
  - 任务1.2 内存池改进 [待开始]
[组2] 异步系统开发
  - 任务2.1 IO框架 [进行中]
  - 任务2.2 事件循环 [阻塞]
```

### 3. 进度指示
```
【DEV:并行进度】
[组1] [=====>----] 5/10
[组2] [===>------] 3/10
```

## 工作流程

### 1. 启动前
- PM必须先读取计划文件
- 无计划则创建初始计划
- 标注任务优先级[P0/P1/P2]
- 识别可并行执行的任务

### 2. 执行中
- 记录日志（简明扼要）
- 严格遵循计划推进
- 及时调整偏差
- 每3个子任务重审计划
- 优先处理阻塞任务

### 3. 检查点（强制）
触发条件：
- 每30分钟 或
- 完成3个子任务

执行顺序：
1. 读取历史日志
2. 分析完成度
3. 更新计划文件
4. 确认下一步任务

检查项：
- 进度对比
- 优先级排序
- 资源分配
- 并行机会

### 4. 阶段结束
- 更新进度
- 重读文档
- 确认方向
- 总结经验

## 工具使用规则

### 1. 搜索工具
- 指定目录范围
- 关注相关结果
- 直接用于下一步

### 2. 文件操作
- read_file 只读必要范围
- edit_file 用于日志记录
- parallel_apply 优先使用

### 3. 命令执行
- 记录成功/失败
- 避免大量输出
- 优先后台任务

### 4. 信息管理
- 使用重要度标记[高/中/低]
- 使用[详情]块折叠
- 合并相似操作
- 记录失败原因和解决方案
