# TinyCC Cosmopolitan 重构计划

## 目标
基于 TinyCC 的核心编译器技术,结合 Cosmopolitan 实现真正的单一二进制跨平台编译器。

## 架构设计

### 1. 核心组件
- 词法分析器 (tccpp.c)
- 语法分析器 (tccgen.c)
- 代码生成器 (x86_64-gen.c)
- APE 格式生成器 (tccape.c)

### 2. 需要移除的组件
- 多平台支持代码
  - arm/ arm64/ riscv64/ 等平台相关代码
  - 平台特定的链接器代码
  - 平台特定的汇编器代码
- 传统目标文件格式
  - PE 格式支持
  - Mach-O 格式支持
  - 仅保留基本 ELF 支持

### 3. 需要重构的部分
- 系统调用层
  - 使用 Cosmopolitan 的系统调用接口
  - 移除平台特定的系统调用代码
- 内存管理
  - 使用 Cosmopolitan 的内存分配函数
  - 统一内存对齐和页面管理
- 文件 I/O
  - 使用 Cosmopolitan 的文件操作接口
  - 统一路径处理

## 实施步骤

1. 基础清理
   - [ ] 移除不需要的平台代码
   - [ ] 清理过时的构建系统
   - [ ] 删除冗余的配置选项

2. 核心重构
   - [ ] 重构内存管理
   - [ ] 重构系统调用接口
   - [ ] 重构文件 I/O

3. APE 支持
   - [ ] 实现 APE 格式生成
   - [ ] 添加 Cosmopolitan 链接支持
   - [ ] 处理重定位

4. 编译器功能
   - [ ] 保留核心 C99 支持
   - [ ] 添加必要的 GNU C 扩展
   - [ ] 实现基本优化

## 当前状态

- [x] 项目初始化完成
- [x] 基本构建环境搭建
- [ ] 开始代码清理

## 下一步计划

1. 代码清理
   - 确定要保留的核心文件
   - 移除不需要的平台代码
   - 简化构建系统

2. 基础重构
   - 添加 Cosmopolitan 头文件支持
   - 重构内存管理接口
   - 实现基本的 APE 格式支持

## 风险管理

1. 技术风险
   - 编译器 ABI 兼容性
   - 性能影响
   - 内存管理复杂性

2. 缓解措施
   - 渐进式重构
   - 持续集成测试
   - 保持核心功能稳定

## 备注

- 项目重点从"多平台支持"转向"单一二进制跨平台"
- 利用 Cosmopolitan 处理平台差异
- 保持编译器核心逻辑清晰简单
